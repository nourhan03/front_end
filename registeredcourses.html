<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المواد المسجلة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="registration.css">
    <style>
        html, body {
          overflow-y: auto;
          margin: 0;
          padding: 0;
          direction: rtl;
          font-family: Tahoma, sans-serif;
          background-color: #f7fafd;
        }
        .student-sidebar {
          background-color: #003366;
          color: white;
          min-width: 230px;
          position: fixed;
          right: 0;
          top: 0;
          height: 100vh;
          z-index: 1000;
        }
        .student-sidebar .title {
          font-size: 18px;
          font-weight: 600;
          margin-bottom: 20px;
          color: white;
        }
        .student-sidebar .link {
          color: #ddd;
          margin: 12px;
          align-items: center;
        }
        .me {
          margin: 25px;
        }
        .student-sidebar ul.nav {
          flex-grow: 1;
          display: flex;
          flex-direction: column;
          padding-left: 0;
          margin-bottom: 0;
        }
        .student-sidebar .nav-link {
          color: #ddd;
          margin: 2px;
          align-items: center;
          display: flex;
          flex-direction: row;
          padding: 8px 12px;
          border-radius: 4px;
          text-decoration: none;
          transition: background-color 0.3s ease, color 0.3s ease;
        }
        .student-sidebar .nav-link i {
          margin-left: 10px;
          width: 24px;
          text-align: center;
        }
        .student-sidebar .nav-link.active {
          background-color: #ffc107;
          color: white;
        }
        .student-sidebar .nav-link:hover {
          background-color: rgba(255, 255, 255, 0.176);
          color: white !important;
        }
        .main-content {
          margin-right: 230px;
          padding: 40px;
        }
        .header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 30px;
        }
        .header h2 {
          color: #003366;
          font-weight: 700;
        }
        .course-card {
          background: white;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(0, 51, 102, 0.1);
          margin-bottom: 25px;
          border: 1px solid #e8f0fe;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .course-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 25px rgba(0, 51, 102, 0.15);
        }
        .course-header {
          background: linear-gradient(135deg, #003366 0%, #004080 100%);
          color: white;
          padding: 20px;
          border-radius: 12px 12px 0 0;
          position: relative;
        }
        .course-header h4 {
          margin: 0;
          font-weight: 700;
          font-size: 1.3rem;
        }
        .course-code {
          background: #ffc107;
          color: #003366;
          padding: 4px 12px;
          border-radius: 20px;
          font-weight: 600;
          font-size: 0.9rem;
          display: inline-block;
          margin-top: 8px;
        }
        .course-body {
          padding: 25px;
        }
        .course-info {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 20px;
        }
        .info-item {
          display: flex;
          align-items: flex-start;
          gap: 12px;
        }
        .info-icon {
          background: #f0f8ff;
          color: #003366;
          width: 40px;
          height: 40px;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }
        .info-content h6 {
          color: #003366;
          font-weight: 600;
          margin: 0 0 5px 0;
          font-size: 0.9rem;
        }
        .info-content p {
          color: #555;
          margin: 0;
          font-size: 0.95rem;
          line-height: 1.4;
        }
        .course-description {
          background: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          border-right: 4px solid #ffc107;
          margin-top: 15px;
        }
        .course-description h6 {
          color: #003366;
          font-weight: 600;
          margin-bottom: 8px;
        }
        .course-description p {
          color: #555;
          margin: 0;
          line-height: 1.5;
        }
        .status-badge {
          position: absolute;
          top: 15px;
          left: 15px;
          background: #28a745;
          color: white;
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 0.8rem;
          font-weight: 600;
        }
        .loading {
          text-align: center;
          padding: 50px;
          color: #003366;
        }
        .loading i {
          font-size: 3rem;
          margin-bottom: 20px;
          color: #ffc107;
        }
        .error {
          background: #f8d7da;
          color: #721c24;
          padding: 20px;
          border-radius: 8px;
          border: 1px solid #f5c6cb;
          text-align: center;
        }
        .stats-summary {
          background: white;
          border-radius: 12px;
          padding: 25px;
          margin-bottom: 30px;
          box-shadow: 0 4px 15px rgba(0, 51, 102, 0.1);
          border: 1px solid #e8f0fe;
        }
        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
        }
        .stat-item {
          text-align: center;
          padding: 20px;
          background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
          border-radius: 8px;
          border: 1px solid #d1e7ff;
        }
        .stat-number {
          font-size: 2rem;
          font-weight: 700;
          color: #003366;
          margin-bottom: 5px;
        }
        .stat-label {
          color: #555;
          font-weight: 600;
        }
        body { background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%); }
        .main-content { padding: 2.5rem 2rem; }
        .api-card {
          background: #fff;
          border-radius: 18px;
          box-shadow: 0 4px 24px #00336618;
          border-right: 6px solid #0d6efd;
          margin-bottom: 2.5rem;
          padding: 2.2rem 2rem 1.5rem 2rem;
          transition: box-shadow 0.3s, transform 0.3s;
          position: relative;
        }
        .api-card .card-title {
          font-size: 1.35rem;
          font-weight: bold;
          color: #003366;
          margin-bottom: 1.2rem;
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .courses-list {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
          gap: 1.5rem;
        }
        .course-card {
          background: #f7fafd;
          border-radius: 14px;
          box-shadow: 0 2px 10px #00336611;
          border-right: 4px solid #0d6efd;
          padding: 1.2rem 1rem 1rem 1rem;
          transition: box-shadow 0.2s, border-color 0.2s;
          position: relative;
        }
        .course-title { font-size: 1.1rem; font-weight: bold; color: #0d6efd; margin-bottom: 0.4rem; }
        .course-code { font-size: 1rem; color: #003366; font-weight: 600; }
        .course-desc { font-size: 0.97rem; color: #444; margin: 0.5rem 0; }
        .prof { color: #6c757d; font-size: 0.97rem; margin-bottom: 0.2rem; }
        .meta { font-size: 0.95rem; color: #888; margin-top: 0.2rem; display: flex; flex-wrap: wrap; gap: 0.4rem; }
        @media (max-width: 900px) { .main-content { padding: 1rem; } .api-card { padding: 1.2rem 0.5rem; } .courses-list { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="student-sidebar p-3">
        <div class="text-center mb-4">
          <h5 class="title">صفحة الطالب<br>بكلية العلوم - جامعة الفيوم</h5>
          <img src="images/3d-graduate-male-student-with-hat-cartoon-character_10560477.png!f305cw" alt="User" class="rounded-circle" width="60">
          <p class="mb-0">أحمد محمد علي</p>
          <small>رقم القيد: 2022021234</small>
        </div>
        <hr>
        <ul class="nav flex-column">
          <li class="nav-item"><a href="registeredcourses.html" class="nav-link active"><i class="bi bi-journal-bookmark-fill"></i> المواد المسجلة</a></li>
          <li class="nav-item"><a href="stucourses.html" class="nav-link"><i class="bi bi-clipboard2-check-fill"></i> تسجيل المواد</a></li>
          <li class="nav-item"><a href="stuschedule.html" class="nav-link"><i class="bi bi-calendar-week"></i> الجدول الدراسي</a></li>
          <li class="nav-item"><a href="stugrades.html" class="nav-link"><i class="bi bi-person-check"></i> الدرجات والنتائج</a></li>
          <li class="nav-item"><a href="stuprofile.html" class="nav-link"><i class="bi bi-person-circle"></i> الملف الشخصي</a></li>
          <li class="nav-item"><a href="stugrades.html" class="nav-link"><i class="fas fa-chart-bar"></i> تحليل الاداء الاكاديمي</a></li>
          <li class="nav-item"><a href="acadimeicwarning.html" class="nav-link"><i class="fas fa-exclamation-triangle"></i> الانذارات الاكاديمية</a></li>
          <li class="nav-item"><a href="stupaths.html" class="nav-link"><i class="fas fa-code-branch"></i> المسارات الاكاديمية</a></li>
          <li class="nav-item"><a href="graduation-eligibility.html" class="nav-link"><i class="fas fa-graduation-cap"></i> التحقق من أهلية التخرج</a></li>
          <li class="nav-item"><a href="studashboard.html" class="nav-link"><i class="bi bi-speedometer2"></i> التقارير</a></li>
          <li class="nav-item"><a href="#" class="nav-link n"><i class="bi bi-box-arrow-right"></i> تسجيل الخروج</a></li>
        </ul>
      </nav>
    <div class="main-content">
        <div class="header">
            <h2><i class="bi bi-journal-bookmark-fill"></i> المواد المسجلة</h2>
        </div>
        
        <!-- Loading State -->
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <h4>جاري تحميل المواد المسجلة...</h4>
        </div>

        <!-- Error State -->
        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <h4>حدث خطأ في تحميل البيانات</h4>
            <p>يرجى المحاولة مرة أخرى لاحقاً</p>
        </div>

        <!-- Stats Summary -->
        <div id="stats" class="stats-summary" style="display: none;">
            <h4 class="mb-3"><i class="bi bi-graph-up"></i> ملخص المواد المسجلة</h4>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalCourses">0</div>
                    <div class="stat-label">إجمالي المواد</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalCredits">0</div>
                    <div class="stat-label">إجمالي الساعات المعتمدة</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="activeCourses">0</div>
                    <div class="stat-label">المواد النشطة</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="semester">1</div>
                    <div class="stat-label">الفصل الدراسي</div>
                </div>
            </div>
        </div>

        <!-- Courses Container -->
        <div id="coursesContainer"></div>

        <div class="api-card" id="dynamic-summary-card" style="border-right-color:#17a2b8; display:none;">
          <div class="card-title"><i class="fa-solid fa-info-circle" style="color:#17a2b8;"></i> ملخص المواد المسجلة في الجلسة</div>
          <div id="dynamic-summary-content"></div>
        </div>
        <div id="session-registered-courses" class="api-card" style="border-right-color:#28a745; display:none;">
          <div class="card-title"><i class="fa-solid fa-check-circle" style="color:#28a745;"></i> المواد التي تم تسجيلها في هذه الجلسة</div>
          <div class="courses-list" id="session-registered-list"></div>
        </div>
    </div>

    <script>
        // API URL
        const API_URL = 'http://facultymanagementsystemapi.runasp.net/api/Course/CoursesByStudentId/3700';

        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const statsEl = document.getElementById('stats');
        const coursesContainer = document.getElementById('coursesContainer');

        // Fetch courses data
        async function fetchCourses() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const courses = await response.json();
                displayCourses(courses);
                updateStats(courses);
            } catch (error) {
                console.error('Error fetching courses:', error);
                showError();
            }
        }

        // Display courses
        function displayCourses(courses) {
            loadingEl.style.display = 'none';
            statsEl.style.display = 'block';
            
            if (courses.length === 0) {
                coursesContainer.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle"></i>
                        <h4>لا توجد مواد مسجلة حالياً</h4>
                        <p>يمكنك التسجيل في المواد من صفحة تسجيل المواد</p>
                    </div>
                `;
                return;
            }

            const coursesHTML = courses.map(course => {
                // زر إلغاء التسجيل
                const cancelBtn = `<button class="btn btn-danger btn-cancel" style="margin-top:0.7rem;" data-courseid="${course.id}">إلغاء التسجيل</button>`;
                return `
                <div class="course-card" data-courseid="${course.id}">
                    <div class="course-header">
                        <div class="status-badge">${course.enrollmentStatus}</div>
                        <h4>${course.name}</h4>
                        <div class="course-code">${course.code}</div>
                    </div>
                    <div class="course-body">
                        <div class="course-info">
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div class="info-content">
                                    <h6>أستاذ المادة</h6>
                                    <p>${course.professorName}</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-building"></i>
                                </div>
                                <div class="info-content">
                                    <h6>القسم</h6>
                                    <p>${course.departmentName}</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-collection"></i>
                                </div>
                                <div class="info-content">
                                    <h6>المجموعة</h6>
                                    <p>${course.divisionNames}</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="info-content">
                                    <h6>الفصل الدراسي</h6>
                                    <p>الفصل ${course.semester}</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-clock"></i>
                                </div>
                                <div class="info-content">
                                    <h6>الساعات المعتمدة</h6>
                                    <p>${course.credits} ساعة</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="bi bi-link-45deg"></i>
                                </div>
                                <div class="info-content">
                                    <h6>المتطلبات السابقة</h6>
                                    <p>${course.preCourseName}</p>
                                </div>
                            </div>
                        </div>
                        <div class="course-description">
                            <h6><i class="bi bi-file-text"></i> وصف المادة</h6>
                            <p>${course.description}</p>
                        </div>
                        ${cancelBtn}
                    </div>
                </div>
                `;
            }).join('');

            coursesContainer.innerHTML = coursesHTML;
            // تفعيل زرار الإلغاء
            coursesContainer.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.onclick = function() {
                    const courseId = Number(this.getAttribute('data-courseid'));
                    // احذف الكورس من localStorage (لو موجود)
                    let registered = JSON.parse(localStorage.getItem('registered_courses') || '[]');
                    registered = registered.filter(c => c.id !== courseId);
                    localStorage.setItem('registered_courses', JSON.stringify(registered));
                    // أخفِ الكارد من الصفحة
                    const card = this.closest('.course-card');
                    if(card) card.remove();
                    // رسالة نجاح
                    alert('تم إلغاء التسجيل');
                };
            });
        }

        // Update statistics
        function updateStats(courses) {
            const totalCourses = courses.length;
            const totalCredits = courses.reduce((sum, course) => sum + course.credits, 0);
            const activeCourses = courses.filter(course => course.enrollmentStatus === 'قيد الدراسة').length;
            const semester = courses.length > 0 ? courses[0].semester : 1;

            document.getElementById('totalCourses').textContent = totalCourses;
            document.getElementById('totalCredits').textContent = totalCredits;
            document.getElementById('activeCourses').textContent = activeCourses;
            document.getElementById('semester').textContent = semester;
        }

        // Show error
        function showError() {
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', fetchCourses);

        // دالة عرض المواد المسجلة في الجلسة الحالية فقط (من localStorage فقط)
        function renderSessionRegisteredCoursesCard() {
          const container = document.getElementById('session-registered-courses');
          const list = document.getElementById('session-registered-list');
          let registered = JSON.parse(localStorage.getItem('registered_courses') || '[]');
          if (!container || !list) return;
          if (registered.length === 0) {
            container.style.display = 'none';
            return;
          }
          container.style.display = '';
          list.innerHTML = registered.map(c => `
            <div class="course-card" style="border-right-color:#28a745">
              <div class="course-title"><i class="fa-solid fa-check-circle" style="color:#28a745"></i> ${c.name}</div>
              <div class="course-code">كود: ${c.code || ''}</div>
              <div class="course-desc">${c.description || ''}</div>
              <div class="prof">${c.professor || ''}</div>
              <div class="meta">
                ${(c.meta||[]).map(m => `<span class="badge bg-secondary">${m}</span>`).join(' ')}
              </div>
              <button class="btn btn-danger btn-cancel" style="margin-top:0.7rem;" data-courseid="${c.id}">إلغاء التسجيل</button>
            </div>
          `).join('');
          // تفعيل زرار الإلغاء
          list.querySelectorAll('.btn-cancel').forEach(btn => {
            btn.onclick = function() {
              const courseId = Number(this.getAttribute('data-courseid'));
              // احذف الكورس من localStorage
              let registered = JSON.parse(localStorage.getItem('registered_courses') || '[]');
              registered = registered.filter(c => c.id !== courseId);
              localStorage.setItem('registered_courses', JSON.stringify(registered));
              // أعد رسم الكارد ليختفي الكورس
              renderDynamicSummary();
              renderSessionRegisteredCoursesCard();
              // رسالة نجاح
              alert('تم إلغاء التسجيل');
            };
          });
        }
        document.addEventListener('DOMContentLoaded', renderSessionRegisteredCoursesCard);

        // ملخص ديناميكي للمواد المسجلة في الجلسة (localStorage)
        function renderDynamicSummary() {
          const container = document.getElementById('dynamic-summary-card');
          const content = document.getElementById('dynamic-summary-content');
          let registered = JSON.parse(localStorage.getItem('registered_courses') || '[]');
          if (!container || !content) return;
          if (registered.length === 0) {
            container.style.display = 'none';
            return;
          }
          container.style.display = '';
          const totalCourses = registered.length;
          const totalCredits = registered.reduce((sum, c) => {
            let credits = 0;
            if (typeof c.credits === 'number') {
              credits = c.credits;
            } else if (typeof c.credits === 'string') {
              credits = parseInt(c.credits) || 0;
            } else if (c.meta && Array.isArray(c.meta)) {
              // أحياناً الساعات تكون في meta مثل "3 ساعات"
              const found = c.meta.find(m => m.includes('ساع'));
              if (found) {
                const num = found.match(/\d+/);
                if (num) credits = parseInt(num[0]);
              }
            }
            return sum + credits;
          }, 0);
          content.innerHTML = `
            <div style="font-size:1.1rem; color:#003366;">
              <b>عدد المواد:</b> ${totalCourses} <br>
              <b>إجمالي الساعات:</b> ${totalCredits}
            </div>
          `;
        }
        document.addEventListener('DOMContentLoaded', function() {
          renderDynamicSummary();
          renderSessionRegisteredCoursesCard();
        });

        function renderRegisteredCourses() {
          const list = document.getElementById('registered-courses-list');
          let registered = JSON.parse(localStorage.getItem('registered_courses') || '[]');
          if (registered.length === 0) {
            list.innerHTML = '<div class="error-msg" style="text-align:center;color:#888;font-size:1.1rem;">لا يوجد مواد مسجلة حتى الآن</div>';
            return;
          }
          list.innerHTML = registered.map(c => `
            <div class="course-card">
              <div class="course-title"><i class="fa-solid fa-check-circle" style="color:#28a745"></i> ${c.name}</div>
              <div class="course-code">كود: ${c.code || ''}</div>
              <div class="course-desc">${c.description || ''}</div>
              <div class="prof">${c.professor || ''}</div>
              <div class="meta">
                ${(c.meta||[]).map(m => `<span class="badge bg-secondary">${m}</span>`).join(' ')}
              </div>
              <button class="btn btn-danger btn-cancel" style="margin-top:0.7rem;" data-courseid="${c.id}">إلغاء التسجيل</button>
            </div>
          `).join('');
          // تفعيل زرار الإلغاء
          list.querySelectorAll('.btn-cancel').forEach(btn => {
            btn.onclick = function() {
              const courseId = Number(this.getAttribute('data-courseid'));
              // احذف الكورس من localStorage
              let registered = JSON.parse(localStorage.getItem('registered_courses') || '[]');
              registered = registered.filter(c => c.id !== courseId);
              localStorage.setItem('registered_courses', JSON.stringify(registered));
              // أعد رسم الكارد ليختفي الكورس
              renderDynamicSummary && renderDynamicSummary();
              renderRegisteredCourses();
              // رسالة نجاح
              alert('تم إلغاء التسجيل');
            };
          });
        }
    </script>
</body>
</html> 